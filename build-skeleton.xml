<?xml version="1.0"?>

<!-- In order to compile sources, it is necessary having installed an JDK
(a simple JRE will not be sufficient -> no javac). -->

<!--
Main targets supported by this skeleton:

jar: compile create local jar, requires deplibs to contain the jars from the
     submodules, either because they are delivered or can be compiled.

compile: compile locally, requires deplibs to contain the jars from the
     submodules

test: run local tests for this module

doc: create local api documentation

clean: remove locally created class and jar files

TARGETS THAT SHOULD ONLY BE USED BY PEOPLE THAT KNOW WHAT THEY'RE DOING

all: build all submodules and the current module, creating jars in deplibs
     for the submodules and in target for the local module

alltest: run local tests and tests in all submodules

allclean: remove all created class and jar files, including those in deplibs.
     WARNING: should only be called if deplibs can be restored, which needs
     the code for all required submodules!


For special needs, the following stub targets should be superseded

compile-special
test-special
jar-special
clean-special

They are guaranteed to be executed before their local counterparts, but after
initialization. jar-special is executed after compile.

Additionally, if you need to extend the classpath for compilation and jar'ing,
use a path with id

classpath-special

which will be added to the default classpath

-->

<project>

  <!-- ================================================================= -->
  <!-- PROPERTIES                                                        -->
  <!-- ================================================================= -->

  <property name="skeleton.version" value="0.5"/>

  <property name="ant.build.javac.target"      value="1.6"/>

  <property name="lib.dir"           value="lib/java"/>

  <property name="source.dir"        value="src/main/java"/>
  <property name="classes.dir"       value="target/classes"/>

  <property name="tests.source.dir"  value="src/test/java"/>
  <property name="tests.classes.dir" value="target/test-classes"/>

  <property name="tests.reports.dir" value="target/test-reports"/>

  <property name="apidoc.dir"        value="target/apidocs"/>

  <property name="version"           value="0.1"/>
  <property name="vname"             value="${ant.project.name}-${version}"/>

  <property name="jar.file"          value="${ant.project.name}.jar"/>

  <patternset id="sources">
    <include name="**/*.java"/>
  </patternset>

  <path id="classpath-special"/>

  <!-- ================================================================= -->
  <!-- SUBMODULES TEMPLATE                                               -->
  <!-- ================================================================= -->

  <target name="subant" description="make one submodule">
    <ant dir="${dir}" target="${target}" inheritAll="false">
      <property name="deplibs.dir" value="${deplibs.dir}"/>
    </ant>
  </target>

  <!-- The way to specify modules this module depends on:

  <target name="modules" description="make modules">
    <antcall target="subant">
      <param name="target" value="${target}"/>
      <param name="dir" value="<module-dir>"/>
    </antcall>
  </target>

  -->

  <target name="modules" description="make modules"/>

  <!-- ================================================================= -->
  <!-- TARGETS                                                           -->
  <!-- ================================================================= -->


  <!-- =================================================================== -->
  <!-- Init build system                                                   -->
  <!-- =================================================================== -->

  <target name="init" depends="-init-external, -init-root">
    <tstamp/>
    <exec executable="svnversion" searchpath="true" dir="${basedir}">
      <redirector outputproperty="svnversion">
        <outputfilterchain>
          <replaceregex pattern=".*:" replace=""/>
        </outputfilterchain>
      </redirector>
    </exec>
    <available file="${tests.source.dir}" type="dir" property="tests.present"/>
    <available file="${source.dir}" type="dir" property="sources.present"/>
    <path id="classpath">
      <fileset dir="${lib.dir}" erroronmissingdir="false">
        <include name="**/*.jar"/>
      </fileset>
      <fileset dir="${deplibs.dir}" erroronmissingdir="false">
        <include name="**/*.jar"/>
      </fileset>
      <path refid="classpath-special"/>
    </path>
  </target>

  <!-- We are the root system / module, we have our own deplibs and target
       jar target folder
  -->
  <target name="-init-root" unless="deplibs.dir">
    <property name="deplibs.dir" value="${basedir}/deplibs/java"/>
    <mkdir dir="${deplibs.dir}"/>
    <property name="jar.dir" value="target"/>
  </target>

  <!-- We are NOT the root system / module, put the jars into deplibs of the
       root system / module
  -->
  <target name="-init-external" if="deplibs.dir">
    <property name="jar.dir" value="${deplibs.dir}"/>
  </target>

  <!-- ================================================================= -->
  <!-- ALL target to build all module jars, etc.                         -->
  <!-- ================================================================= -->

  <target name="all" depends="init">
    <antcall target="modules">
      <param name="target" value="jar-external"/>
    </antcall>
    <antcall target="jar"/>
  </target>

  <!-- ================================================================= -->
  <!-- COMPILATION targets                                               -->
  <!-- ================================================================= -->

  <!-- target to compile additional things in this project, meant to be
       overwritten -->
  <target name="compile-special"/>

  <target name="-init-compile">
    <mkdir dir="${classes.dir}"/>
  </target>

  <target name="compile" description="compile main sources and modules"
          depends="init, -init-compile, compile-special" if="sources.present">
    <javac debug="yes" deprecation="yes"
           srcdir="${source.dir}" destdir="${classes.dir}">
      <patternset refid="sources"/>
      <classpath refid="classpath"/>
      <compilerarg value="-Xlint"/>
    </javac>
  </target>

  <target name="-compile-all" description="compile tests too" depends="compile"
          if="tests.present">
    <mkdir dir="${tests.classes.dir}"/>
    <mkdir dir="${tests.reports.dir}"/>
    <javac debug="yes" deprecation="yes"
           srcdir="${tests.source.dir}" destdir="${tests.classes.dir}">
      <patternset refid="sources"/>
      <classpath>
        <path refid="classpath"/>
        <pathelement path="${tests.classes.dir}"/>
        <pathelement path="${classes.dir}"/>
      </classpath>
      <compilerarg value="-Xlint"/>
    </javac>
  </target>

  <!-- =================================================================== -->
  <!-- TEST targets                                                        -->
  <!-- =================================================================== -->

  <target name="alltest" depends="all, test-modules, test"/>

  <target name="test-modules">
    <antcall target="modules">
      <param name="target" value="alltest"/>
    </antcall>
  </target>

  <!-- target to do additional tests for this project,
       meant to be overwritten -->
  <target name="test-special"/>

  <target name="test" depends="init, test-special, -test-html-report"/>

  <target name="-test-run" description="run unit tests" depends="-compile-all"
          if="tests.present">
    <mkdir dir="${tests.reports.dir}"/>
    <junit printsummary="yes" haltonfailure="no"  haltonerror="no">
      <classpath>
        <path refid="classpath"/>
        <pathelement path="${tests.classes.dir}"/>
        <pathelement path="${classes.dir}"/>
      </classpath>
      <formatter type="xml"/>
      <batchtest fork="yes" todir="${tests.reports.dir}">
        <!--formatter type="failure"/-->
        <fileset dir="${tests.source.dir}" includes="**/*Test.java"/>
      </batchtest>
    </junit>
  </target>

  <target name="-test-html-report" depends="-test-run"
          if="tests.present">
    <junitreport todir="${tests.reports.dir}">
      <fileset dir="${tests.reports.dir}" includes="TEST-*.xml"/>
      <report format="frames" todir="${tests.reports.dir}"/>
    </junitreport>
  </target>

  <!-- =================================================================== -->
  <!-- Basic Packaging: JAR file creation                                  -->
  <!-- =================================================================== -->

  <!-- target to create additional jars for this project, meant to be
       overwritten -->
  <target name="jar-special"/>

  <!-- if this is an submodule, jar.dir points do external dir, and this target
       puts the generated jars into the right place
  -->
  <target name="jar" depends="compile, jar-special"
          description="jar the main code">
    <jar destfile="${jar.dir}/${jar.file}" compress="true">
      <manifest>
        <attribute name="Bundle-Vendor" value="DFKI"/>
        <attribute name="Bundle-Version" value="${svnversion}-${version}"/>
        <attribute name="Bundle-Name" value="${ant.project.name}"/>
        <attribute name="Bundle-ClassPath" value="${jar.file}"/>
      </manifest>
      <fileset dir="${classes.dir}"/>
    </jar>
  </target>

  <!-- if this is an submodule, jar.dir points do external dir, and jar already
       puts the generated jars into the right place. We still have to provide
       the external jars we locally depend on
  -->
  <target name="jar-external" depends="-jar-modules, jar"
          description="move this module's external jars to the root module's location">
    <copy todir="${deplibs.dir}" verbose="true">
      <fileset dir="${lib.dir}" erroronmissingdir="false">
        <include name="*.jar"/>
      </fileset>
    </copy>
  </target>

  <target name="-jar-modules">
    <antcall target="modules">
      <param name="target" value="jar-external"/>
    </antcall>
  </target>

  <!-- =================================================================== -->
  <!-- Cleanup                                                             -->
  <!-- =================================================================== -->

  <target name="allclean"
          description="remove class files, local jars and wars AND jars coming   from submodules"
          depends="clean, -depclean">
    <delete failonerror="false">
      <fileset dir="${deplibs.dir}" includes="*.jar"/>
    </delete>
  </target>

  <target name="-depclean">
    <antcall target="modules">
      <param name="target" value="allclean"/>
    </antcall>
  </target>

  <!-- target to do specific project cleanup, meant to be overwritten -->
  <target name="clean-special"/>

  <target name="clean" depends="init, clean-special"
          description="remove class files and generated jars">
    <delete failonerror="false">
      <fileset dir="${classes.dir}" includes="**/*.class"/>
    </delete>
    <delete failonerror="false">
      <fileset dir="${tests.classes.dir}" includes="**/*.class"/>
    </delete>
    <delete failonerror="false">
      <fileset dir="${jar.dir}" includes="*.jar"/>
    </delete>
    <delete failonerror="false">
      <fileset dir="${tests.reports.dir}" includes="**/*"/>
    </delete>
    <delete failonerror="false" dir="${apidoc.dir}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Javadoc                                                             -->
  <!-- =================================================================== -->

  <target name="doc" depends="init, source-doc"/>

  <target name="source-doc">
    <javadoc destdir="${apidoc.dir}" author="true" version="true" use="true"
             windowtitle="${apidoc.title}">
      <fileset dir="${source.dir}" defaultexcludes="yes"/>
      <doctitle><![CDATA[<h1>${apidoc.title}</h1>]]></doctitle>
      <bottom><![CDATA[<i>${apidoc.bottomline}</i>]]></bottom>
    </javadoc>
  </target>

  <target name="test-doc">
    <javadoc destdir="${apidoc.dir}" author="true" version="true" use="true"
             windowtitle="${apidoc.title} - Unit test documentation">
      <fileset dir="${tests.source.dir}" defaultexcludes="yes"/>
      <doctitle><![CDATA[<h1>${apidoc.title}</h1>]]></doctitle>
      <bottom><![CDATA[<i>${apidoc.bottomline}</i>]]></bottom>
    </javadoc>
  </target>

  <!-- =================================================================== -->
  <!-- Advanced Packaging: Creating Distribution (still TODO)              -->
  <!-- =================================================================== -->


  <!-- this is just a stub, and most likely only of interest for systems, or
       standalone modules
  -->
  <target name="tar" description="build distribution tar file">
    <exec executable="svnversion" failonerror="false"
          outputproperty="svnversion"/>
    <tar destfile="${vname}${svnversion}.tar"
         basedir=".">
      <fileset dir="${source.dir}"/>
      <fileset dir="${tests.source.dir}"/>
      <fileset dir="." includes="build.xml"/>
    </tar>
    <gzip src="../${vname}.tar" destfile="../${vname}.tar.gz"/>
    <delete failonerror="false" file="../${vname}.tar"/>
  </target>


  <!--
jar: compile + jar local classes and put jar into target
compile:compile local classes

all ==>  jar-external for all submodules, then jar locally

jar-external: ==> call jar external for all submodules, compile and jar
                  (putting it into root's deplibs),
                  and copy all local "external" jars into deplibs
!!! Correctly breaks if recursive dependencies not fulfilled (internal target)

clean ==> clean only locally produced classes and jars (in target)

allclean -> clean + clean-external + delete deplibs
	 !!! Correctly breaks if recursive dependencies not fulfilled

clean-external ==> clean all submodules & clean (locally) (internal target)

test -> run all local tests

alltest -> run the tests of all submodules,
           (putting reports into common folder?) & run local test

doc
  -->

</project>
